# 端到端测试指南

## 快速开始

### 1. 首次运行或重新登录

```bash
# 手动运行登录设置（只需运行一次，或认证失效时重新运行）
pnpm test:e2e:setup
```

生成的认证文件：`e2e/.auth/user.json`（已加入 .gitignore）

### 2. 运行测试

```bash
# 界面测试（复用登录状态，推荐日常使用）
pnpm test:e2e              # 无头模式
pnpm test:e2e:headed       # 有头模式（可见浏览器）

# 登录测试（独立运行，不使用认证状态）
pnpm test:e2e:auth

# 接口测试（无需浏览器）
pnpm test:e2e:api

# 全部测试
pnpm test:e2e:all

# 调试模式
pnpm test:e2e:debug

# 查看测试报告
pnpm test:e2e:report
```

## 测试分类

| 项目         | 说明                                     | 命令               |
| ------------ | ---------------------------------------- | ------------------ |
| **设置**     | 登录并保存认证状态（手动运行）           | `test:e2e:setup`   |
| **认证**     | 登录流程测试（独立运行，不使用登录状态） | `test:e2e:auth`    |
| **接口**     | 接口测试（无需浏览器）                   | `test:e2e:api`     |
| **界面**     | 界面测试（自动复用登录状态）             | `test:e2e`（默认） |

## 开发模式 vs 生产模式

```bash
# 开发模式（测试 localhost:3000 前端开发服务器）
DEV_MODE=1 pnpm test:e2e

# 生产模式（测试 localhost:8080 打包后的前端）
pnpm test:e2e
```

## 工作流程

```
┌─────────────────────────────────────────┐
│  首次运行或认证失效                      │
│  pnpm test:e2e:setup                   │
│  ↓ 生成 e2e/.auth/user.json             │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│  日常开发                                │
│  pnpm test:e2e          ← 快速！         │
│  （自动复用登录状态，无需重复登录）       │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│  测试登录功能                            │
│  pnpm test:e2e:auth                    │
│  （独立运行，不影响其他测试）             │
└─────────────────────────────────────────┘
```

## 最佳实践

1. **首次运行**：先执行 `pnpm test:e2e:setup` 保存登录状态
2. **日常开发**：直接运行 `pnpm test:e2e`，速度快（无需重复登录）
3. **登录失效**：重新运行 `pnpm test:e2e:setup`
4. **测试登录流程**：使用 `pnpm test:e2e:auth`（独立测试）
5. **持续集成**：运行 `pnpm test:e2e:all`（包含设置 + 全部测试）

## 常见问题

### 问：测试失败提示未登录？

答：运行 `pnpm test:e2e:setup` 重新生成认证文件

### 问：如何跳过登录测试？

答：使用 `pnpm test:e2e`（默认排除 auth.spec.ts）

### 问：如何单独测试登录功能？

答：使用 `pnpm test:e2e:auth`

### 问：开发模式测试端口是什么？

答：`DEV_MODE=1` 时测试 `localhost:3000`（需先运行 `pnpm dev`）

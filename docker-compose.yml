# Full stack test: Nacos + Sentinel Dashboard + Token Server
services:
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: nacos
    restart: always
    environment:
      - MODE=standalone
      - NACOS_AUTH_ENABLE=false
      - JVM_XMS=256m
      - JVM_XMX=256m
    ports:
      - "8848:8848"
      - "9848:9848"
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-sf",
          "http://localhost:8848/nacos/v1/console/health/readiness",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # 前端构建镜像
  frontend:
    image: sentinel/frontend:local
    build:
      context: ./dashboard-frontend
    container_name: sentinel-frontend-builder
    # 仅用于构建，不需要长时间运行
    command: ["echo", "Frontend build complete"]

  sentinel-dashboard:
    image: sentinel/dashboard:local
    restart: always
    build:
      context: ./sentinel-dashboard
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-false}
        - FRONTEND_IMAGE=sentinel/frontend:local
    container_name: sentinel-dashboard
    depends_on:
      nacos:
        condition: service_healthy
      frontend:
        condition: service_completed_successfully
    environment:
      - SENTINEL_DASHBOARD_SERVER_PORT=8080
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - NACOS_GROUP=DEFAULT_GROUP
      - SENTINEL_DASHBOARD_AUTH_USERNAME=sentinel
      - SENTINEL_DASHBOARD_AUTH_PASSWORD=sentinel
      - JAVA_OPTS=-Xms256m -Xmx512m
    ports:
      - "8080:8080"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf -X POST 'http://localhost:8080/auth/login?username=sentinel&password=sentinel' || exit 1",
        ]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 60s

  token-server:
    image: sentinel/token-server:local
    restart: always
    build:
      context: ./token-server
      args:
        - USE_CHINA_MIRROR=${USE_CHINA_MIRROR:-false}
    container_name: token-server
    hostname: token-server
    depends_on:
      sentinel-dashboard:
        condition: service_healthy
    environment:
      - APP_NAME=sentinel-token-server
      - SERVER_PORT=8081
      # Sentinel Dashboard 配置
      - SENTINEL_DASHBOARD_HOST=sentinel-dashboard
      - SENTINEL_DASHBOARD_PORT=8080
      - CSP_SENTINEL_API_PORT=8719
      - SERVICE_NAME=token-server
      # Cluster Token Server 配置
      - CLUSTER_SERVER_PORT=18730
      - CLUSTER_IDLE_SECONDS=600
      # Nacos 配置（用于从 Nacos 加载规则）
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_GROUP_ID=SENTINEL_GROUP
      # 命名空间（可选，逗号分隔的应用名）
      # - CLUSTER_NAMESPACES=app1,app2
      # 启用测试接口（生产环境设为 false 或不设置）
      - DEMO_API_ENABLED=true
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "8081:8081" # HTTP 服务端口
      - "8719:8719" # Sentinel API 端口（Dashboard 通信）
      - "18730:18730" # Cluster Token Server 端口（集群限流通信）
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8081/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
